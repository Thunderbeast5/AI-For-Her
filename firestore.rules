rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is the owner of an existing document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users collection: any authenticated user can read profiles, but only the owner can write
    match /users/{userId} {
  allow read: if true;
  allow write: if isOwner(userId);
}
    
    // Mentors can be read by any authenticated user
    match /mentors/{mentorId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'mentor';
    }

    // Investors can be read by any authenticated user
    match /investors/{investorId} {
      allow read: if isAuthenticated();
    }
    
    // Entrepreneurs can be read by any authenticated user
    match /entrepreneurs/{entrepreneurId} {
        allow read: if isAuthenticated();
    }

    // Connections: entrepreneur <-> mentor relationships
    match /connections/{connectionId} {
      // Allow creating a connection if the authenticated user is the entrepreneur or mentor in the new doc
      allow create: if isAuthenticated() && (
        request.resource.data.entrepreneurId == request.auth.uid ||
        request.resource.data.mentorId == request.auth.uid
      );

      // Allow reading a connection if the user is involved (or any authenticated user during analytics development)
      allow read: if isAuthenticated();

      // Allow updates (e.g. mentor accepts, entrepreneur completes payment)
      allow update: if isAuthenticated() && (
        // User must be part of this connection
        (resource.data.entrepreneurId == request.auth.uid ||
         resource.data.mentorId == request.auth.uid) &&
        // Core linkage fields cannot change
        request.resource.data.entrepreneurId == resource.data.entrepreneurId &&
        request.resource.data.mentorId == resource.data.mentorId
      );

      // Allow listing for authenticated users (client filters by entrepreneurId/mentorId or role)
      allow list: if isAuthenticated();
    }
    
    // Startups rules
    match /startups/{startupId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isOwner(resource.data.userId);
      allow list: if isAuthenticated();
    }

    // Investment Projects rules
    match /investment-projects/{projectId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
        // During development, allow any authenticated user (e.g. investors) to update funding-related fields
        allow update: if isAuthenticated();
        allow delete: if isOwner(resource.data.userId);
        allow list: if isAuthenticated();
    }

    // Mentor Groups rules
    match /mentorGroups/{groupId} {
        // Mentors can read their own groups; participants can read groups they are in
        allow read: if isAuthenticated();
        allow list: if isAuthenticated();
        // Only mentors can create groups
        allow create: if isAuthenticated() && request.resource.data.mentorId == request.auth.uid;
        // During development, allow any authenticated user to update (join/leave) groups
        allow update: if isAuthenticated();
    }

    // Group Sessions rules - during development allow any authenticated mentor to manage sessions
    match /groupSessions/{sessionId} {
      allow read, create, update, delete, list: if isAuthenticated();
    }

    // Products can be read by anyone, but only written by the owner
    match /products/{productId} {
        allow read: if true;
        allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
        allow update, delete: if isOwner(resource.data.userId);
    }

    // Orders can be created by anyone, but only managed by the buyer or owner
    match /orders/{orderId} {
        allow create: if true;
        allow read, update, delete: if isAuthenticated() && (request.auth.uid == resource.data.customer.userId || request.auth.uid in resource.data.owners);
    }

    // Self-help groups can be read by anyone, written by members or for join requests
    match /self-help-groups/{groupId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow write: if isAuthenticated();
    }

    // Self Help Group Chats - access is granted if user is a member of the parent group
    match /self-help-group-chats/{groupId} {
      allow read, create: if isAuthenticated() && get(/databases/$(database)/documents/self-help-groups/$(groupId)).data.members.hasAny([request.auth.uid]);

      // Messages subcollection
      match /messages/{messageId} {
        allow read, create: if isAuthenticated() && get(/databases/$(database)/documents/self-help-groups/$(groupId)).data.members.hasAny([request.auth.uid]);
      }
    }

    // Mentor group chats (used by GroupChatInterface for mentor groups) - during development allow any authenticated user
    match /group-chats/{groupId} {
      allow read, create, update: if isAuthenticated();

      match /messages/{messageId} {
        allow read, create: if isAuthenticated();
      }
    }

    // Personal mentor-entrepreneur chats: during development, allow any authenticated user to read docs and send messages
    match /chats/{chatId} {
      allow read, list: if isAuthenticated();

      match /messages/{messageId} {
        allow read, create: if isAuthenticated();
      }
    }

    // Sessions collection used for mentor analytics - allow read during development
    match /sessions/{sessionId} {
      allow read, list: if isAuthenticated();
    }

    // Investments collection used for investor analytics - allow read during development
    match /investments/{investmentId} {
      allow read, list: if isAuthenticated();
    }

    // Notifications rules
    match /notifications/{notificationId} {
      allow read, write: if isOwner(resource.data.userId);
      allow list: if isAuthenticated();
    }
  }
}
